var ChildProcess = require('child_process');
var Path = require('path');

Runner.timeout = 1000;
module.exports = Runner;
function Runner(path, callback) {
  console.log("path", path);
  var isDone;
  var start = Date.now();
  var events = [{start: start}];
  var timeout = setTimeout(function () {
    if (isDone) return;
    pushEvent({timeout: true})
    isDone = true;
    child.kill();
    callback(null, events);
  }, Runner.timeout);
  var child = ChildProcess.spawn(process.execPath, [path], {
    cwd: Path.dirname(path)
  });
  child.stdout.setEncoding('utf8');
  child.stderr.setEncoding('utf8');
  child.on("error", function (err) {
    if (isDone) return;
    pushEvent({error: err})
    isDone = true;
    clearTimeout(timeout);
    callback(err, events);
  });
  child.stdout.on('data', function (chunk) {
    if (isDone) return;
    pushEvent({stdout: chunk})
  });
  child.stderr.on('data', function (chunk) {
    if (isDone) return;
    pushEvent({stderr: chunk})
  });
  child.on('exit', function (code, signal) {
    if (isDone) return;
    pushEvent({exit: code, signal:signal});
    isDone = true;
    clearTimeout(timeout);
    callback(null, events);
  });
  function pushEvent(event) {
    var now = Date.now();
    event.delay = now - start;
    start = now;
    events.push(event);
  }
}